{
  "description": "CAN 2025 - Flow Optimis√© avec Auto-Pronostic (1 match) + Meilleure Gestion Erreurs",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "set_phone",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": -50,
          "y": -500
        }
      }
    },
    {
      "name": "set_phone",
      "type": "set-variables",
      "transitions": [
        {
          "next": "check_stop_keyword",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body}}",
            "key": "user_message"
          },
          {
            "type": "string",
            "value": "{{now | date: '%Y-%m-%d %H:%M:%S'}}",
            "key": "timestamp"
          }
        ],
        "offset": {
          "x": 90,
          "y": -660
        }
      }
    },
    {
      "name": "check_stop_keyword",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "check_source",
          "event": "noMatch"
        },
        {
          "next": "http_log_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "STOP demand√©",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,stop,Stop,ARRET,arret,Arret"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {
          "x": -140,
          "y": -300
        }
      }
    },
    {
      "name": "check_source",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "set_source_direct",
          "event": "noMatch"
        },
        {
          "next": "set_source_affiche",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Affiche",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_AFF_GOMBE,START_AFF_MASINA,START_AFF_LEMBA,START_AFF_BANDAL,START_AFF_NGALI,START_AFF_MATETE,START_AFF_KINTAMBO,START_AFF_NDJILI,START_AFF_LIMETE"
            }
          ]
        },
        {
          "next": "set_source_pdv",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source PDV",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_PDV_BRACONGO,START_PDV_BAR1,START_PDV_BAR2,START_PDV_DEPOT1,START_PDV_DEPOT2"
            }
          ]
        },
        {
          "next": "set_source_digital",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Digital",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_FB,START_IG,START_TIKTOK,START_WA_STATUS,START_WEB"
            }
          ]
        },
        {
          "next": "set_source_flyer",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Flyer",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_FLYER_UNI,START_FLYER_RUE,START_FLYER_EVENT"
            }
          ]
        },
        {
          "next": "set_source_radio",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Radio",
              "arguments": [
                "{{trigger.message.Body}}"
              ],
              "type": "matches_any_of",
              "value": "START_RADIO,START_RTGA,START_RTNC"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {
          "x": -370,
          "y": 70
        }
      }
    },
    {
      "name": "set_source_affiche",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "AFFICHE",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_AFF_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": -800,
          "y": 450
        }
      }
    },
    {
      "name": "set_source_pdv",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "PDV_BRACONGO",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_PDV_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": -400,
          "y": 450
        }
      }
    },
    {
      "name": "set_source_digital",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DIGITAL",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": 0,
          "y": 450
        }
      }
    },
    {
      "name": "set_source_flyer",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "FLYER",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_FLYER_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": 400,
          "y": 450
        }
      }
    },
    {
      "name": "set_source_radio",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "RADIO",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | replace: 'START_', '' | replace: 'RADIO_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": 800,
          "y": 450
        }
      }
    },
    {
      "name": "set_source_direct",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_user",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DIRECT",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "SANS_QR",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": 1200,
          "y": 450
        }
      }
    },
    {
      "name": "http_check_user",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_user_status",
          "event": "success"
        },
        {
          "next": "msg_error_api",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 700
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/check-user"
      }
    },
    {
      "name": "msg_error_api",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_error",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 950
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ö†Ô∏è Erreur technique temporaire.\n\nR√©essaye dans quelques instants.\n\nüìû Support : contact@sportcash.ci"
      }
    },
    {
      "name": "check_user_status",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_log_scan",
          "event": "noMatch"
        },
        {
          "next": "http_log_scan",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Nouvel utilisateur",
              "arguments": [
                "{{widgets.http_check_user.parsed.status}}"
              ],
              "type": "equal_to",
              "value": "NOT_FOUND"
            }
          ]
        },
        {
          "next": "http_check_pronostics",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "D√©j√† inscrit",
              "arguments": [
                "{{widgets.http_check_user.parsed.status}}"
              ],
              "type": "equal_to",
              "value": "INSCRIT"
            }
          ]
        },
        {
          "next": "msg_reactivation",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Ancien STOP",
              "arguments": [
                "{{widgets.http_check_user.parsed.status}}"
              ],
              "type": "equal_to",
              "value": "STOP"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_check_user.parsed.status}}",
        "offset": {
          "x": 0,
          "y": 920
        }
      }
    },
    {
      "name": "http_check_pronostics",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_pronostics_status",
          "event": "success"
        },
        {
          "next": "msg_deja_inscrit_simple",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 540,
          "y": 920
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\":\"{{flow.variables.phone_number}}\"}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/user-pronostics"
      }
    },
    {
      "name": "check_pronostics_status",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_remaining_matches",
          "event": "noMatch"
        },
        {
          "next": "msg_historique_complet",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Tous les pronostics faits",
              "arguments": [
                "{{widgets.http_check_pronostics.parsed.has_all_pronostics}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        },
        {
          "next": "msg_remaining_matches",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Des matchs restants",
              "arguments": [
                "{{widgets.http_check_pronostics.parsed.has_all_pronostics}}"
              ],
              "type": "equal_to",
              "value": "false"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_check_pronostics.parsed.has_all_pronostics}}",
        "offset": {
          "x": 540,
          "y": 1170
        }
      }
    },
    {
      "name": "msg_historique_complet",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_historique_complet",
          "event": "sent"
        },
        {
          "next": "end_historique_complet",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1220,
          "y": 1430
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\n‚úÖ Tu as d√©j√† fait tous tes pronostics disponibles !\n\n{{widgets.http_check_pronostics.parsed.historique_message}}\n\nüçÄ Bonne chance pour tes paris !"
      }
    },
    {
      "name": "msg_remaining_matches",
      "type": "send-message",
      "transitions": [
        {
          "next": "http_get_matchs_existing",
          "event": "sent"
        },
        {
          "next": "end_deja_inscrit",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 540,
          "y": 1430
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\n{{widgets.http_check_pronostics.parsed.historique_message}}{{widgets.http_check_pronostics.parsed.remaining_matches_message}}\n\n#SportCash\n\nüìµ Tape STOP pour te d√©sinscrire",
        "media_url": "https://tohuman-9933.twil.io/lonaci_new.jpeg"
      }
    },
    {
      "name": "http_get_matchs_existing",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_has_matchs_existing",
          "event": "success"
        },
        {
          "next": "msg_error_matchs",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 540,
          "y": 1680
        },
        "method": "GET",
        "content_type": "application/x-www-form-urlencoded",
        "add_twilio_auth": false,
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/matches/formatted?limit=5"
      }
    },
    {
      "name": "msg_error_matchs",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_error",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1900,
          "y": 1680
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ö†Ô∏è Impossible de charger les matchs.\n\nR√©essaye plus tard.\n\nüìû Support : contact@sportcash.ci"
      }
    },
    {
      "name": "check_has_matchs_existing",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "end_deja_inscrit",
          "event": "noMatch"
        },
        {
          "next": "check_single_match_existing",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Des matchs disponibles",
              "arguments": [
                "{{widgets.http_get_matchs_existing.parsed.has_matches}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matchs_existing.parsed.has_matches}}",
        "offset": {
          "x": 540,
          "y": 1930
        }
      }
    },
    {
      "name": "check_single_match_existing",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_liste_matchs_existing",
          "event": "noMatch"
        },
        {
          "next": "set_match_auto_existing",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Un seul match",
              "arguments": [
                "{{widgets.http_get_matchs_existing.parsed.single_match}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        },
        {
          "next": "msg_liste_matchs_existing",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Plusieurs matchs",
              "arguments": [
                "{{widgets.http_get_matchs_existing.parsed.single_match}}"
              ],
              "type": "equal_to",
              "value": "false"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matchs_existing.parsed.single_match}}",
        "offset": {
          "x": 540,
          "y": 2180
        }
      }
    },
    {
      "name": "set_match_auto_existing",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_existing.parsed.match.id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_existing.parsed.match.team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_existing.parsed.match.team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": 140,
          "y": 2430
        }
      }
    },
    {
      "name": "msg_liste_matchs_existing",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_choix_match",
          "event": "incomingMessage"
        },
        {
          "next": "msg_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_timeout",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 940,
          "y": 2430
        },
        "from": "{{flow.channel.address}}",
        "body": "{{widgets.http_get_matchs_existing.parsed.message}}",
        "timeout": "3600"
      }
    },
    {
      "name": "msg_deja_inscrit_simple",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_deja_inscrit",
          "event": "sent"
        },
        {
          "next": "end_deja_inscrit",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1090,
          "y": 930
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\nTu es d√©j√† inscrit(e) √† ‚öΩBabiFoot CITY by Lonaci 2025\n\nüîîPr√©pare-toi √† jouer et √† gagner !\n\n#BabiFoot\n\nüìµ Tape STOP pour te d√©sinscrire",
        "media_url": "https://tohuman-9933.twil.io/lonaci_new.jpeg"
      }
    },
    {
      "name": "end_historique_complet",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "HISTORIQUE_COMPLET",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 1220,
          "y": 1680
        }
      }
    },
    {
      "name": "end_deja_inscrit",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DEJA_INSCRIT",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 890,
          "y": 1580
        }
      }
    },
    {
      "name": "msg_reactivation",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_reactivation",
          "event": "incomingMessage"
        },
        {
          "next": "http_log_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_error",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1510,
          "y": 1080
        },
        "from": "{{flow.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\nTu t'√©tais d√©sinscrit(e) de BRACONGO FOOT.\n\nTu veux te r√©inscrire pour participer aux jeux et gagner des cadeaux ? üéÅ\n\n‚ö†Ô∏è Confirme :\n‚úÖ 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour revenir\nüëâ Tape NON pour rester d√©sinscrit",
        "timeout": "3600"
      }
    },
    {
      "name": "check_reactivation",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_reste_stop",
          "event": "noMatch"
        },
        {
          "next": "http_log_reactivate",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI r√©activation",
              "arguments": [
                "{{widgets.msg_reactivation.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"
            }
          ]
        },
        {
          "next": "msg_reste_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON reste stop",
              "arguments": [
                "{{widgets.msg_reactivation.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "NON,non,Non,N,n,NO,no,No,0,STOP,stop,Stop"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_reactivation.inbound.Body}}",
        "offset": {
          "x": 1800,
          "y": 1440
        }
      }
    },
    {
      "name": "http_log_reactivate",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_reactivation_ok",
          "event": "success"
        },
        {
          "next": "msg_reactivation_ok",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1410,
          "y": 1680
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"REACTIVATED\",\n  \"timestamp\": \"{{flow.variables.timestamp}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/reactivate"
      }
    },
    {
      "name": "msg_reactivation_ok",
      "type": "send-message",
      "transitions": [
        {
          "next": "http_get_matchs_reactivated",
          "event": "sent"
        },
        {
          "next": "end_reactivated",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1100,
          "y": 1950
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üéâ Content de te revoir {{widgets.http_check_user.parsed.name}} !\n\nTu es de retour dans la FAMILLE BRACONGO FOOT 2025 ! ü¶Å\n\nVoici les matchs disponibles pour tes pronostics ! ‚öΩ"
      }
    },
    {
      "name": "http_get_matchs_reactivated",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_has_matchs_reactivated",
          "event": "success"
        },
        {
          "next": "msg_error_matchs",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1100,
          "y": 2200
        },
        "method": "GET",
        "content_type": "application/x-www-form-urlencoded",
        "add_twilio_auth": false,
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/matches/formatted?limit=5"
      }
    },
    {
      "name": "check_has_matchs_reactivated",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "end_reactivated",
          "event": "noMatch"
        },
        {
          "next": "check_single_match_reactivated",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Des matchs disponibles",
              "arguments": [
                "{{widgets.http_get_matchs_reactivated.parsed.has_matches}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matchs_reactivated.parsed.has_matches}}",
        "offset": {
          "x": 1100,
          "y": 2450
        }
      }
    },
    {
      "name": "check_single_match_reactivated",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_liste_matchs_reactivated",
          "event": "noMatch"
        },
        {
          "next": "set_match_auto_reactivated",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Un seul match",
              "arguments": [
                "{{widgets.http_get_matchs_reactivated.parsed.single_match}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        },
        {
          "next": "msg_liste_matchs_reactivated",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Plusieurs matchs",
              "arguments": [
                "{{widgets.http_get_matchs_reactivated.parsed.single_match}}"
              ],
              "type": "equal_to",
              "value": "false"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matchs_reactivated.parsed.single_match}}",
        "offset": {
          "x": 1100,
          "y": 2700
        }
      }
    },
    {
      "name": "set_match_auto_reactivated",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_reactivated.parsed.match.id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_reactivated.parsed.match.team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_reactivated.parsed.match.team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": 700,
          "y": 2950
        }
      }
    },
    {
      "name": "msg_liste_matchs_reactivated",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_choix_match",
          "event": "incomingMessage"
        },
        {
          "next": "msg_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_timeout",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 1500,
          "y": 2950
        },
        "from": "{{flow.channel.address}}",
        "body": "{{widgets.http_get_matchs_reactivated.parsed.message}}",
        "timeout": "3600"
      }
    },
    {
      "name": "msg_reste_stop",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_stop",
          "event": "sent"
        },
        {
          "next": "end_stop",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1850,
          "y": 1880
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "OK, pas de souci ! üëã\n\nTu restes d√©sinscrit(e).\n\nSi tu changes d'avis, envoie-nous un message.\n\nA BIENTOT ! ü¶Å"
      }
    },
    {
      "name": "http_log_scan",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_accueil",
          "event": "success"
        },
        {
          "next": "msg_accueil",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 1150
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"source_type\": \"{{flow.variables.source_type}}\",\n  \"source_detail\": \"{{flow.variables.source_detail}}\",\n  \"timestamp\": \"{{flow.variables.timestamp}}\",\n  \"status\": \"SCAN\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/scan"
      }
    },
    {
      "name": "msg_accueil",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_optin",
          "event": "incomingMessage"
        },
        {
          "next": "http_log_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_error",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 1400
        },
        "from": "{{flow.channel.address}}",
        "body": "‚öΩVillage FOOT by SportCash 2025\n\nSportCash t'invite dans ses Villages FOOT √† Abidjan !\n\nüéÅ 200 % de bonus t'attendent !\n\n‚ö†Ô∏è Pour continuer, confirme :\n‚úÖ Tu as 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour t'inscrire",
        "media_url": "https://tohuman-9933.twil.io/lonaci_new.jpeg",
        "timeout": "3600"
      }
    },
    {
      "name": "check_optin",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_relance_optin",
          "event": "noMatch"
        },
        {
          "next": "http_log_optin",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI accept√©",
              "arguments": [
                "{{widgets.msg_accueil.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"
            }
          ]
        },
        {
          "next": "http_log_refus",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON refus√©",
              "arguments": [
                "{{widgets.msg_accueil.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "NON,non,Non,N,n,NO,no,No,0"
            }
          ]
        },
        {
          "next": "http_log_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "STOP demand√©",
              "arguments": [
                "{{widgets.msg_accueil.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,stop,Stop,ARRET,arret,Arret"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_accueil.inbound.Body}}",
        "offset": {
          "x": -400,
          "y": 1650
        }
      }
    },
    {
      "name": "msg_relance_optin",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_optin_relance",
          "event": "incomingMessage"
        },
        {
          "next": "http_log_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_error",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -900,
          "y": 1900
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Je n'ai pas compris !\n\nPour t'inscrire √† SOLIBRA FOOT 2025 :\n‚úÖ Tu as 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour confirmer\nüëâ Tape NON pour refuser",
        "timeout": "1800"
      }
    },
    {
      "name": "check_optin_relance",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_log_abandon",
          "event": "noMatch"
        },
        {
          "next": "http_log_optin",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI accept√© relance",
              "arguments": [
                "{{widgets.msg_relance_optin.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"
            }
          ]
        },
        {
          "next": "http_log_refus",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON refus√© relance",
              "arguments": [
                "{{widgets.msg_relance_optin.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "NON,non,Non,N,n,NO,no,No,0,STOP,stop,Stop"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_relance_optin.inbound.Body}}",
        "offset": {
          "x": -900,
          "y": 2150
        }
      }
    },
    {
      "name": "http_log_optin",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_demande_nom",
          "event": "success"
        },
        {
          "next": "msg_demande_nom",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 1900
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"OPTIN\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/optin"
      }
    },
    {
      "name": "msg_demande_nom",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_nom",
          "event": "incomingMessage"
        },
        {
          "next": "http_log_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_error",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 2150
        },
        "from": "{{flow.channel.address}}",
        "body": "Parfait ! ‚úÖ\n\nBienvenue dans la famille SportCash !\n\nQuel est ton nom ou pseudo ?",
        "timeout": "3600"
      }
    },
    {
      "name": "validate_nom",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "set_nom",
          "event": "noMatch"
        },
        {
          "next": "msg_relance_nom",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Nom trop court",
              "arguments": [
                "{{widgets.msg_demande_nom.inbound.Body}}"
              ],
              "type": "less_than",
              "value": "2"
            }
          ]
        },
        {
          "next": "http_log_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Stop demand√©",
              "arguments": [
                "{{widgets.msg_demande_nom.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,stop,Stop,ARRET,arret,Arret"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_demande_nom.inbound.Body}}",
        "offset": {
          "x": -400,
          "y": 2400
        }
      }
    },
    {
      "name": "msg_relance_nom",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "set_nom_relance",
          "event": "incomingMessage"
        },
        {
          "next": "http_log_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_error",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -900,
          "y": 2650
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Donne-moi au moins 2 lettres !\n\nTon pr√©nom ou pseudo ?",
        "timeout": "1800"
      }
    },
    {
      "name": "set_nom_relance",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_inscription",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_relance_nom.inbound.Body | capitalize}}",
            "key": "user_name"
          }
        ],
        "offset": {
          "x": -900,
          "y": 2900
        }
      }
    },
    {
      "name": "set_nom",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_log_inscription",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_demande_nom.inbound.Body | capitalize}}",
            "key": "user_name"
          }
        ],
        "offset": {
          "x": -180,
          "y": 2680
        }
      }
    },
    {
      "name": "http_log_inscription",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_confirmation",
          "event": "success"
        },
        {
          "next": "msg_error_inscription",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 2900
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"name\": \"{{flow.variables.user_name}}\",\n  \"source_type\": \"{{flow.variables.source_type}}\",\n  \"source_detail\": \"{{flow.variables.source_detail}}\",\n  \"status\": \"INSCRIT\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/inscription"
      }
    },
    {
      "name": "msg_error_inscription",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_error",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -800,
          "y": 3150
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ö†Ô∏è Erreur lors de l'inscription.\n\nR√©essaye avec un nouveau message.\n\nüìû Support : contact@sportcash.ci"
      }
    },
    {
      "name": "msg_confirmation",
      "type": "send-message",
      "transitions": [
        {
          "next": "http_get_matchs_new",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 3150
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est bon {{flow.variables.user_name}} !\n\nTu fais d√©sormais partie de la *TEAM SportCash Village FOOT 2025* ‚öΩüî•\n\nüëâ Pour ne rien rater, d√©couvre notre plateforme ici :\nhttps://sportcash.ci/sport-home\n\nüéÅ *√Ä gagner* :\n‚Ä¢ üéâ Bonus de *200 %* sur ton premier rechargement (min. 500 FCFA)\n‚Ä¢ üéüÔ∏è Tickets de matchs / entr√©es stade (pour les participants pr√©sents au Maroc)\n\nüì≤ Maintenant, place aux *pronostics* !"
      }
    },
    {
      "name": "http_get_matchs_new",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_has_matchs_new",
          "event": "success"
        },
        {
          "next": "msg_error_matchs",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 3400
        },
        "method": "GET",
        "content_type": "application/x-www-form-urlencoded",
        "add_twilio_auth": false,
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/matches/formatted?limit=5"
      }
    },
    {
      "name": "check_has_matchs_new",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_aucun_match_apres_inscription",
          "event": "noMatch"
        },
        {
          "next": "check_single_match_new",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Des matchs disponibles",
              "arguments": [
                "{{widgets.http_get_matchs_new.parsed.has_matches}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matchs_new.parsed.has_matches}}",
        "offset": {
          "x": -400,
          "y": 3650
        }
      }
    },
    {
      "name": "check_single_match_new",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_liste_matchs_new",
          "event": "noMatch"
        },
        {
          "next": "set_match_auto_new",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Un seul match",
              "arguments": [
                "{{widgets.http_get_matchs_new.parsed.single_match}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        },
        {
          "next": "msg_liste_matchs_new",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Plusieurs matchs",
              "arguments": [
                "{{widgets.http_get_matchs_new.parsed.single_match}}"
              ],
              "type": "equal_to",
              "value": "false"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_get_matchs_new.parsed.single_match}}",
        "offset": {
          "x": -400,
          "y": 3900
        }
      }
    },
    {
      "name": "set_match_auto_new",
      "type": "set-variables",
      "transitions": [
        {
          "next": "send_single_match_message",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.match.id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.match.team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.match.team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": -800,
          "y": 4150
        }
      }
    },
    {
      "name": "send_single_match_message",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_choix_prono",
          "event": "incomingMessage"
        },
        {
          "next": "msg_timeout_prono",
          "event": "timeout"
        },
        {
          "next": "http_log_timeout",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -800,
          "y": 4400
        },
        "from": "{{flow.channel.address}}",
        "body": "{{widgets.http_get_matchs_new.parsed.message}}",
        "timeout": "3600"
      }
    },
    {
      "name": "msg_aucun_match_apres_inscription",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -800,
          "y": 3900
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚öΩ Aucun match n'est disponible pour le moment.\n\nüìÖ On te contactera d√®s qu'un nouveau match sera ouvert !\n\nüçÄ Pr√©pare-toi √† jouer et √† gagner ! #SportCash"
      }
    },
    {
      "name": "msg_liste_matchs_new",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_choix_match",
          "event": "incomingMessage"
        },
        {
          "next": "msg_timeout",
          "event": "timeout"
        },
        {
          "next": "http_log_timeout",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 4150
        },
        "from": "{{flow.channel.address}}",
        "body": "{{widgets.http_get_matchs_new.parsed.message}}",
        "timeout": "3600"
      }
    },
    {
      "name": "msg_timeout",
      "type": "send-message",
      "transitions": [
        {
          "next": "http_log_timeout",
          "event": "sent"
        },
        {
          "next": "http_log_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 2200,
          "y": 2200
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚è±Ô∏è Temps √©coul√© !\n\nRelance le processus pour faire un nouveau pronostic.\n\nEnvoie-nous un message pour recommencer ! üëã"
      }
    },
    {
      "name": "check_choix_match",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_choix_invalide",
          "event": "noMatch"
        },
        {
          "next": "set_match_1",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match 1",
              "arguments": [
                "{{widgets.msg_liste_matchs_new.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "1"
            }
          ]
        },
        {
          "next": "set_match_2",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match 2",
              "arguments": [
                "{{widgets.msg_liste_matchs_new.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "2"
            }
          ]
        },
        {
          "next": "set_match_3",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match 3",
              "arguments": [
                "{{widgets.msg_liste_matchs_new.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "3"
            }
          ]
        },
        {
          "next": "set_match_4",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match 4",
              "arguments": [
                "{{widgets.msg_liste_matchs_new.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "4"
            }
          ]
        },
        {
          "next": "set_match_5",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match 5",
              "arguments": [
                "{{widgets.msg_liste_matchs_new.inbound.Body}}"
              ],
              "type": "matches_any_of",
              "value": "5"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_liste_matchs_new.inbound.Body}}",
        "offset": {
          "x": 0,
          "y": 4400
        }
      }
    },
    {
      "name": "set_match_1",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[0].id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[0].team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[0].team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": -800,
          "y": 4650
        }
      }
    },
    {
      "name": "set_match_2",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[1].id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[1].team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[1].team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": -400,
          "y": 4650
        }
      }
    },
    {
      "name": "set_match_3",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[2].id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[2].team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[2].team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": 0,
          "y": 4650
        }
      }
    },
    {
      "name": "set_match_4",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[3].id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[3].team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[3].team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": 400,
          "y": 4650
        }
      }
    },
    {
      "name": "set_match_5",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_check_existing_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[4].id}}",
            "key": "selected_match_id"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[4].team_a}}",
            "key": "selected_team_a"
          },
          {
            "type": "string",
            "value": "{{widgets.http_get_matchs_new.parsed.matches[4].team_b}}",
            "key": "selected_team_b"
          }
        ],
        "offset": {
          "x": 800,
          "y": 4650
        }
      }
    },
    {
      "name": "msg_choix_invalide",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1200,
          "y": 4650
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ùå Choix invalide !\n\nMerci de choisir un num√©ro de match valide (1-5).\n\nEnvoie-nous un nouveau message pour recommencer ! üëã"
      }
    },
    {
      "name": "http_check_existing_prono",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_has_existing_prono",
          "event": "success"
        },
        {
          "next": "msg_options_prono",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 4900
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\":\"{{flow.variables.phone_number}}\",\"match_id\":{{flow.variables.selected_match_id}}}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/check-pronostic"
      }
    },
    {
      "name": "check_has_existing_prono",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_options_prono",
          "event": "noMatch"
        },
        {
          "next": "msg_prono_deja_existe",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Pronostic existe",
              "arguments": [
                "{{widgets.http_check_existing_prono.parsed.has_pronostic}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_check_existing_prono.parsed.has_pronostic}}",
        "offset": {
          "x": 0,
          "y": 5150
        }
      }
    },
    {
      "name": "msg_prono_deja_existe",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 500,
          "y": 5400
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üö´ *PRONOSTIC D√âJ√Ä ENREGISTR√â*\n\n‚öΩ {{flow.variables.selected_team_a}} vs {{flow.variables.selected_team_b}}\n\nüìä Ton pronostic actuel :\n{{widgets.http_check_existing_prono.parsed.pronostic_details}}\n\nüìÖ Plac√© le : {{widgets.http_check_existing_prono.parsed.created_at}}\n\n‚ùå *Impossible de modifier ton pronostic.*\n\nüçÄ √Ä bient√¥t pour les prochains matchs !\n\nPour rester inform√©(e), teste notre plateforme en cliquant ici üëá\nhttps://sportcash.ci/sport-home"
      }
    },
    {
      "name": "msg_options_prono",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "check_choix_prono",
          "event": "incomingMessage"
        },
        {
          "next": "msg_timeout_prono",
          "event": "timeout"
        },
        {
          "next": "http_log_timeout",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -400,
          "y": 5400
        },
        "from": "{{flow.channel.address}}",
        "body": "üèÜ TON PRONOSTIC DU MATCH ‚öΩ\nüî• {{flow.variables.selected_team_a}} vs {{flow.variables.selected_team_b}} üî•\n\nüëâ Qui va gagner selon toi?\n\n1Ô∏è‚É£ Victoire {{flow.variables.selected_team_a}}\n2Ô∏è‚É£ Victoire {{flow.variables.selected_team_b}}\n3Ô∏è‚É£ ü§ù Match nul\n\nüì© R√©ponds simplement par 1, 2 ou 3 et valide ton pronostic !",
        "timeout": "3600"
      }
    },
    {
      "name": "msg_timeout_prono",
      "type": "send-message",
      "transitions": [
        {
          "next": "http_log_timeout",
          "event": "sent"
        },
        {
          "next": "http_log_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -860,
          "y": 5810
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚è±Ô∏è Temps √©coul√© !\n\nRelance le processus pour faire ton pronostic.\n\nEnvoie-nous un message pour recommencer ! üëã"
      }
    },
    {
      "name": "check_choix_prono",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_prono_invalide",
          "event": "noMatch"
        },
        {
          "next": "set_prono_team_a",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Victoire √©quipe A",
              "arguments": [
                "{{widgets.msg_options_prono.inbound.Body}}"
              ],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "set_prono_team_a",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Victoire √©quipe A (single)",
              "arguments": [
                "{{widgets.send_single_match_message.inbound.Body}}"
              ],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "set_prono_team_b",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Victoire √©quipe B",
              "arguments": [
                "{{widgets.msg_options_prono.inbound.Body}}"
              ],
              "type": "equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "set_prono_team_b",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Victoire √©quipe B (single)",
              "arguments": [
                "{{widgets.send_single_match_message.inbound.Body}}"
              ],
              "type": "equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "set_prono_draw",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match nul",
              "arguments": [
                "{{widgets.msg_options_prono.inbound.Body}}"
              ],
              "type": "equal_to",
              "value": "3"
            }
          ]
        },
        {
          "next": "set_prono_draw",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Match nul (single)",
              "arguments": [
                "{{widgets.send_single_match_message.inbound.Body}}"
              ],
              "type": "equal_to",
              "value": "3"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.msg_options_prono.inbound.Body}}",
        "offset": {
          "x": 0,
          "y": 5650
        }
      }
    },
    {
      "name": "set_prono_team_a",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_save_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "team_a_win",
            "key": "prediction_type"
          }
        ],
        "offset": {
          "x": -400,
          "y": 5900
        }
      }
    },
    {
      "name": "set_prono_team_b",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_save_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "team_b_win",
            "key": "prediction_type"
          }
        ],
        "offset": {
          "x": 0,
          "y": 5900
        }
      }
    },
    {
      "name": "set_prono_draw",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_save_prono",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "draw",
            "key": "prediction_type"
          }
        ],
        "offset": {
          "x": 400,
          "y": 5900
        }
      }
    },
    {
      "name": "msg_prono_invalide",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 800,
          "y": 5900
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ùå Choix invalide !\n\nMerci de r√©pondre par 1, 2 ou 3.\n\nEnvoie-nous un message pour recommencer ! üëã"
      }
    },
    {
      "name": "http_save_prono",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "check_prono_success",
          "event": "success"
        },
        {
          "next": "msg_erreur_prono",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 6150
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\":\"{{flow.variables.phone_number}}\",\"match_id\":{{flow.variables.selected_match_id}},\"prediction_type\":\"{{flow.variables.prediction_type}}\"}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/pronostic"
      }
    },
    {
      "name": "check_prono_success",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_erreur_prono",
          "event": "noMatch"
        },
        {
          "next": "msg_confirmation_prono",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "API Success",
              "arguments": [
                "{{widgets.http_save_prono.parsed.success}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.http_save_prono.parsed.success}}",
        "offset": {
          "x": 0,
          "y": 6400
        }
      }
    },
    {
      "name": "msg_confirmation_prono",
      "type": "send-message",
      "transitions": [
        {
          "next": "msg_remerciement",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 6650
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "{{widgets.http_save_prono.parsed.message}}"
      }
    },
    {
      "name": "msg_erreur_prono",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_error",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 6400
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ùå Erreur lors de l'enregistrement.\n\nMessage : {{widgets.http_save_prono.parsed.message}}\n\nR√©essaye ou contacte le support : contact@sportcash.ci"
      }
    },
    {
      "name": "msg_remerciement",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_success",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 6900
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üéä F√©licitations\n{{flow.variables.user_name}} üéä \n\nTu seras contact√©(e) en cas de tirage victorieux ! üçÄ\n\nPour rester inform√©(e), teste notre plateforme en cliquant ici üëá\nhttps://sportcash.ci/sport-home\n\nNous te remercions et te souhaitons bonne chance pour la s√©lection en tant que gagnant(e) ! üòäüéâ"
      }
    },
    {
      "name": "http_log_refus",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_refus",
          "event": "success"
        },
        {
          "next": "msg_refus",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 100,
          "y": 1900
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"REFUS\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/refus"
      }
    },
    {
      "name": "msg_refus",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_refus",
          "event": "sent"
        },
        {
          "next": "end_refus",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 100,
          "y": 2150
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Pas de probl√®me ! üëã\n\nSi tu changes d'avis, reviens nous voir.\n\nAllez les L√©opards ! ü¶Å\n\n#BracongoNaYo"
      }
    },
    {
      "name": "http_log_stop",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_stop",
          "event": "success"
        },
        {
          "next": "msg_stop",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1110,
          "y": -60
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"STOP\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/stop"
      }
    },
    {
      "name": "msg_stop",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_stop",
          "event": "sent"
        },
        {
          "next": "end_stop",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1110,
          "y": 190
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est not√©.\n\nTu es d√©sinscrit(e) et ne recevras plus de messages de SportCash FOOT.\n\nA Bient√¥t !"
      }
    },
    {
      "name": "http_log_abandon",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_abandon",
          "event": "success"
        },
        {
          "next": "msg_abandon",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1300,
          "y": 2400
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"ABANDON\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/abandon"
      }
    },
    {
      "name": "msg_abandon",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_abandon",
          "event": "sent"
        },
        {
          "next": "end_abandon",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1300,
          "y": 2650
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Pas de probl√®me ! üëã\n\nSi tu veux t'inscrire plus tard, envoie juste OUI.\n\nAllez les L√©opards ! ü¶Å"
      }
    },
    {
      "name": "http_log_timeout",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "success"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1300,
          "y": 1400
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "http_log_error",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_error",
          "event": "success"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1300,
          "y": 1650
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"ERROR\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://can-activation-sportcash.ywcdigital.com/api/can/error"
      }
    },
    {
      "name": "end_success",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "FLOW_COMPLETE",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -200,
          "y": 7150
        }
      }
    },
    {
      "name": "end_reactivated",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "REACTIVATED",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 1100,
          "y": 2950
        }
      }
    },
    {
      "name": "end_refus",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "REFUS",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 100,
          "y": 2400
        }
      }
    },
    {
      "name": "end_stop",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "STOP",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 1120,
          "y": 740
        }
      }
    },
    {
      "name": "end_abandon",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ABANDON",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1300,
          "y": 2900
        }
      }
    },
    {
      "name": "end_timeout",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "TIMEOUT",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1500,
          "y": 1650
        }
      }
    },
    {
      "name": "end_error",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ERROR",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1500,
          "y": 1900
        }
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
